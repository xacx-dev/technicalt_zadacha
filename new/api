# ТЗ: Telegram-бот программы лояльности

## 1. Назначение и задачи бота

Telegram-бот — интерфейс к программе лояльности на базе 1С.

Основные задачи бота:

- Регистрация клиентов в программе лояльности через Telegram.
- Привязка существующих клиентов по номеру телефона к Telegram-аккаунту.
- Предоставление клиенту информации о балансе бонусных баллов.
- Отображение истории операций с баллами.
- Отображение персональных предложений и акций.
- Уведомления о начислениях, списаниях и сгорании баллов.
- Вывод списка магазинов/точек продаж.
- Перевод на менеджера поддержки.
- Работа с реферальной программой (получение реф.кода, начисление бонусов).

Все взаимодействие с 1С и внутренними системами осуществляется через REST API, описанные ниже.

---



## 2. Юзер-кейсы


ОБЩЕЕ ПО АВТОРИЗАЦИИ
- Схема: JWT Bearer.
- Передача: заголовок Authorization: Bearer <JWT>.
- Транспорт: только HTTPS.
- Ротация токенов поддерживается на стороне 1С. Все работа на стороне 1С.
- Дополнительно рекомендуется: Content-Type: application/json; Accept: application/json.


### 2.1. Регистрация и привязка клиента

**Описание:**  
Новый или существующий клиент запускает бота, отправляет номер телефона и, при необходимости, регистрируется в программе лояльности. Telegram ID привязывается к записи клиента.

**Поток:**

1. Пользователь нажимает `Start` / «Начать».
2. Бот показывает краткое описание возможностей.
3. Пользователь отправляет номер телефона (через кнопку `request_contact`).
4. Бот вызывает `GET /api/customer/{phone}`:
   - если клиент найден — привязка `telegram_id` к существующему клиенту (реализация на стороне бэкенда) и возврат данных;
   - если не найден — вызов `POST /api/customer/create` с `source = "telegram"`.
5. Бот отправляет пользователю главное меню

---

### 2.2. Просмотр баланса баллов

**Описание:**  
Авторизованный пользователь запрашивает текущий баланс бонусов.

**Поток:**

1. Пользователь нажимает «Мой баланс».
2. Бот по связанному `phone` вызывает `GET /api/customer/{phone}/balance`.
3. Бот отображает полученные данные

---

### 2.3. История операций с баллами

**Описание:**  
Пользователь просматривает историю начислений, списаний и сгорания баллов с возможностью фильтрации.

**Поток:**

1. Пользователь нажимает «История операций».
2. Бот предлагает выбор периода и типа операций (начисление, списание, сгорание).
3. Бот вызывает `GET /api/customer/{phone}/history` с соответствующими query-параметрами.
4. Результаты выводятся постранично.

---

### 2.4. Персональные предложения и акции

**Описание:**  
Пользователь получает список персональных предложений и акций, актуальных для него.

**Поток:**

1. Пользователь выбирает «Акции и предложения».
2. Бот вызывает `GET /api/customer/{phone}/offers`.
3. Результаты выводятся постранично.

---

### 2.5. Уведомления о событиях по баллам

**Описание:**  
Пользователь автоматически получает уведомления о:

- начислении баллов;
- списании баллов;
- скором сгорании баллов;
- специальных предложениях.

**Поток:**

1. На стороне 1С происходит событие (операция по баллам или акция).
2. 1С отправляет уведомление на `POST /bot/webhook/1c` (входящий webhook бота).
3. Бэкенд бота валидирует запрос по `secret`.
4. Бот отправляет пользователю сообщение в Telegram.

---

### 2.6. Список магазинов

**Описание:**  
Пользователь запрашивает список торговых точек: адреса, контакты, режим работы, геолокацию.

**Поток:**

1. Пользователь нажимает «Магазины».
2. Бот вызывает `GET /api/stores` (при необходимости с фильтрами по городу).
3. Бот отображает список с форматированием и ссылкой на карту.

---

### 2.7. Поддержка

**Описание:**  
Пользователь переходит от бота сразу на оператора поддержки.
---

### 2.8. Реферальная программа

**Описание:**  

- Действующий клиент получает персональный реферальный код или ссылку.
- Новый клиент при регистрации вводит реферальный код.
- Оба получают бонусы по правилам программы.

**Поток (для инициатора):**

1. Пользователь выбирает «Пригласить друга».
2. Бот вызывает `GET /api/customer/{phone}/referral`.
3. Бот показывает реферальный код/ссылку и статистику.

**Поток (для приглашённого):**

1. Новый пользователь регистрируется через бота.
2. В процессе регистрации указывает реферальный код.
3. Бот/бэкенд вызывает `POST /api/referral/apply`.
4. При успешном применении начисляются бонусы инициатору и другу.

---

## 3. Описание API

Ниже приведён список рекомендуемых эндпоинтов и примерные форматы запросов/ответов.

### 3.1. Получение данных клиента по номеру телефона

`GET /api/customer/{phone}`

**Запрос:** без тела.

**Ответ 200 OK (пример):**
```json
{
  "customer_id": "c-001234",
  "phone": "+79995554433",
  "loyalty_status": "active",
  "first_name": "Иван",
  "last_name": "Иванов",
  "registered_at": "2024-09-01T10:15:00Z",
  "telegram_id": 123456789,
  "meta": {}
}
```

---

### 3.2. Создание нового клиента (регистрация)

`POST /api/customer/create`

**Запрос:**
```json
{
  "phone": "+79995554433",
  "first_name": "Иван",
  "last_name": "Иванов",
  "telegram_id": 123456789,
  "source": "telegram"
}
```

**Ответ 201 Created (пример):**
```json
{
  "customer_id": "c-001235",
  "phone": "+79995554433",
  "loyalty_status": "active",
  "registered_at": "2025-11-05T12:00:00Z",
  "welcome_bonus": { "points": 100, "granted": true },
  "message": "Клиент создан и подключён к программе лояльности"
}
```

---

### 3.3. Получение баланса баллов

`GET /api/customer/{phone}/balance`

**Запрос:** без тела.

**Ответ 200 OK (пример):**
```json
{
  "phone": "+79995554433",
  "points_total": 1250,
  "points_blocked": 0,
  "points_expiring": 150,
  "expiring_on": "2025-12-31",
  "forecast_next_month": 980,
  "updated_at": "2025-11-05T10:00:00Z"
}
```

---

### 3.4. История операций с баллами

`GET /api/customer/{phone}/history`

**Query-параметры (опционально):**
- `date_from`
- `date_to`
- `type` — `accrual|writeoff|expire`
- `page`
- `page_size`

**Запрос:** без тела.

**Ответ 200 OK (пример):**
```json
{
  "phone": "+79995554433",
  "items": [
    {
      "operation_id": "op-1001",
      "datetime": "2025-10-30T15:20:10Z",
      "type": "accrual",
      "points": 120,
      "store": "Магазин №1",
      "purchase_amount": 2400.00,
      "comment": "Начисление за покупку"
    }
  ],
  "page": 1,
  "page_size": 50,
  "total": 1
}
```

---

### 3.5. Получение персональных предложений

`GET /api/customer/{phone}/offers`

**Запрос:** без тела.

**Ответ 200 OK (пример):**
```json
{
  "phone": "+79995554433",
  "offers": [
    {
      "offer_id": "of-777",
      "title": "Скидка 10% на следующую покупку",
      "description": "Действует до 30.11.2025. Только для пользователей бота.",
      "valid_to": "2025-11-30",
      "personal": true
    }
  ],
  "generated_at": "2025-11-05T09:59:00Z"
}
```

---

### 3.6. Список магазинов

`GET /api/stores`

**Query-параметры (опционально):**
- `city`
- `page`
- `page_size`

**Запрос:** без тела.

**Ответ 200 OK (пример):**
```json
{
  "items": [
    {
      "store_id": "s-001",
      "name": "Магазин №1",
      "address": "г. Москва, ул. Примерная, 1",
      "phone": "+7 (495) 000-00-00",
      "lat": 55.7558,
      "lon": 37.6176,
      "schedule": "ежедневно 10:00–22:00"
    }
  ]
}
```

---


### 3.7. Реферальная информация клиента

`GET /api/customer/{phone}/referral`

**Запрос:** без тела.

**Ответ 200 OK (пример):**
```json
{
  "phone": "+79995554433",
  "referral_code": "ABC123",
  "invited_count": 5,
  "earned_points": 250
}
```

### 3.8. Применение реферального кода

`POST /api/referral/apply`

**Запрос:**
```json
{
  "referral_code": "ABC123",
  "new_customer_id": "c-009999"
}
```

**Ответ 200 OK (пример):**
```json
{
  "success": true,
  "referrer_bonus": { "points": 50 },
  "friend_bonus": { "points": 100 }
}
```

---

### 3.9. Webhook от 1С к боту (входящий)

`POST /bot/webhook/1c`

**Пример входящего запроса:**
```json
{
  "event": "points.accrual",
  "secret": "********",
  "data": {
    "customer_id": "c-001234",
    "phone": "+79995554433",
    "points": 120,
    "balance_after": 1370,
    "datetime": "2025-11-05T12:30:00Z",
    "message": "Начисление за покупку"
  }
}
```

**Ответ 200 OK (пример):**
```json
{
  "received": true
}
```

---

### 3.12. Формат ошибок (общий)

```json
{
  "error": {
    "code": "string",
    "message": "string",
    "details": {}
  }
}
```
